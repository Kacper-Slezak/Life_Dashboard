<!DOCTYPE html>
<html>
<head>
    <title>API Connections</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Manage API Connections</h1>

        <!-- Google Fit section -->
        <div class="connection-card">
            <h2>Google Fit</h2>
            <button onclick="initGoogleFitAuth()" id="google-fit-btn">
                Authorize with Google Fit
            </button>
            <div id="status-message"></div>
        </div>

        <!-- Button to go back to dashboard -->
        <div class="navigation">
            <a href="/dashboard" class="button">Back to dashboard</a>
        </div>
    </div>

    <script>
        async function initGoogleFitAuth() {
            try {
                const response = await fetch('/api/api-connections/google-fit/auth', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Server error');
                }

                const data = await response.json();
                localStorage.setItem('oauth_state', data.state);
                window.location.href = data.auth_url;

            } catch (error) {
                showError(`Error: ${error.message}`);
            }
        }

        async function loadConnections() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showError('You are not logged in. Redirecting to login...');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }

                const response = await fetch('/api/api-connections/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('Session expired. Redirecting to login...');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                        return;
                    }
                    throw new Error('Error loading data');
                }

                const connections = await response.json();
                const btn = document.getElementById('google-fit-btn');

                // Check whether a Google Fit connection exists
                const googleFitConn = connections.find(conn => conn.provider === 'google_fit');

                if (googleFitConn) {
                    btn.innerHTML = googleFitConn.is_active
                        ? 'Connected to Google Fit <span class="status-dot active"></span>'
                        : 'Authorize with Google Fit <span class="status-dot inactive"></span>';
                } else {
                    btn.innerHTML = 'Authorize with Google Fit';
                }

            } catch (error) {
                showError('Failed to load connections: ' + error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('status-message');
            errorDiv.innerHTML = `<div class="alert error">${message}</div>`;
            setTimeout(() => errorDiv.innerHTML = '', 5000);
        }

        function showSuccess(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="alert success">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        // Check if the user returned from the authorization process
        function checkAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const authSuccess = urlParams.get('auth_success');

            if (authSuccess === 'true') {
                showSuccess('Connection to Google Fit established successfully!');
                // Remove parameters from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (authSuccess === 'false') {
                showError('Failed to connect to Google Fit. Please try again.');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Initialize after page load
        window.addEventListener('load', () => {
            loadConnections();
            checkAuthCallback();
        });
    </script>
</body>
</html>